---
name: Test Python
concurrency:
  group: ${{ github.repository }}-${{ github.head_ref || github.sha }}-${{ github.workflow }}
  cancel-in-progress: true
on:
  workflow_run:
    workflows: ["Lint Python"]
    types:
      - completed

jobs:
  # Run pytest with coverage
  pytest:
    name: Run tests with pytest and coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # Only run if the lint workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Set up Python runtime
        uses: ./.github/actions/setup-python

      - name: Sync dependencies
        run: uv sync --all-extras

      - name: Run tests with coverage
        run: uv run pytest --cov --cov-report=term-missing

      - name: Check coverage threshold
        run: uv run coverage report
